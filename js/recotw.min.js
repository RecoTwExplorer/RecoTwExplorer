/*!
 * RecoTw Explorer - Copyright 2014, Chitoku
 * http://recotw.chitoku.jp/
 *
 * Licensed under MIT License
 * http://www.opensource.org/licenses/mit-license
 *
 * Required libraries:
 * - jQuery
 * - linq.js
 * - Bootstrap
 * - Google Charts
 */
var RecoTwExplorer;!function(t){var e="RecoTw Explorer",n="2.31";$.fn.shake=function(t,e,n){"use strict";return this.each(function(){for(var r=$(this),o=0;t>o;o++)r.animate({left:-e},n/t/4).animate({left:e},n/t/2).animate({left:0},n/t/4)})};var r=function(){function t(){}return t.INCORRECT_REGEX="指定された正規表現は正しくありません。",t.INCORRECT_URL_OR_ID="指定された URL または ID は正しくありません。",t.FAILED_TO_GENERATE_STATUS_URL="ツイートの URL を生成できません。",t.FAILED_TO_GENERATE_USER_URL="ユーザーへの URL を生成できません。",t.FAILED_TO_GENERATE_PROFILE_IMAGE_URL="プロフィール画像の URL を生成できません。",t.FAILED_TO_LOAD_EMBEDDED_TWEET="Twitter 埋め込みツイートの読み込みに失敗しました。",t.SEARCH_HELP_HTML="<dl><dt>ツイート検索</dt><dd><code>/</code> と <code>/</code> で囲むと正規表現検索</dd><dt>ユーザー名検索</dt><dd><code>from:</code> でユーザーを検索<br>カンマ区切りで複数入力</dd><dt>ID 検索</dt><dd><code>id:</code> で ID 検索</dd></dl>",t.STATISTICS_TABLE_HTML='<span class="statistics-table-header" style="border-color: #{0:X6};"><a href="javascript:void(0);" onclick="RecoTwExplorer.Controller.setSearchFilterByUsername(\'{1}\')">{1}</a> ({2})&nbsp;&nbsp;&ndash;&nbsp;&nbsp;{3:P1}</span><br>',t.TWEET_REMOVED_HTML='<blockquote>ツイートは削除されたか、または非公開に設定されています。<a href="{0}" target="_blank">表示</a><hr><div><img src="{1}" onerror="RecoTwExplorer.Controller.onImageError(this)"><span><a href="{2}" target="_blank">@{3}</a></span><p>{4}</p></div></blockquote>',t.LINK_TO_URL_HTML='<a href="{0}" target="_blank">{0}</a>',t.URL_INPUT_AREA=$("#new-record-form .modal-body").html(),t.USERNAME="ユーザ名",t.TWEETS_COUNT="ツイート数",t.NO_RESULT='<p class="text-center" style="margin-top: 200px;">該当ユーザーなし</p>',t.SEARCH_RESULT="検索結果: {0}",t.STATISTICS_COUNT="({0:N0} 件)",t.PAGE_TITLE_SEARCH_RESULT="検索結果: {0} - "+e,t.PAGE_TITLE_NORMAL=e,t.POST_ERRORS={400:"パラメーターが正しくありません。",403:"ツイートの取得に失敗しました。",404:"指定されたツイートは存在しません。",500:"すでに登録されているツイートです。",503:"サーバーで問題が発生しています。",UNKNOWN_ERROR:"原因不明のエラーです。"},t}(),o=function(){function t(t,e,n,r,o,i){void 0===t&&(t=[]),void 0===e&&(e=""),void 0===n&&(n=null),void 0===r&&(r=!1),void 0===o&&(o=2),void 0===i&&(i=1),this.usernames=t,this.body=e,this.id=n,this.regex=r,this.order=o,this.orderBy=i}return t.prototype.isFilteredByUsernames=function(){return void 0!==this.usernames&&this.usernames.length>0},t.prototype.isFilteredByID=function(){return void 0!==this.id&&null!==this.id},t.prototype.isFilteredByBody=function(){return void 0!==this.body&&this.body.length>0},t.prototype.isFiltered=function(){return this.isFilteredByUsernames()||this.isFilteredByID()||this.isFilteredByBody()},t.prototype.toQueryString=function(){var t=[];return this.isFilteredByUsernames()&&(t[t.length]="username="+encodeURIComponent(this.usernames.join(","))),this.isFilteredByID()&&(t[t.length]="id="+encodeURIComponent(this.id)),this.isFilteredByBody()&&(t[t.length]=this.regex?"body="+encodeURIComponent("/"+this.body+"/"):"body="+encodeURIComponent(this.body)),t.length>0?"?"+t.join("&"):""},t.prototype.toKeywords=function(){var t=[];return this.isFilteredByUsernames()&&(t[t.length]="from:"+this.usernames.join(",")),this.isFilteredByID()&&(t[t.length]="id:"+this.id),this.isFilteredByBody()&&(t[t.length]=this.regex?"/"+this.body+"/":this.body),t.join(" ")},t.fromQueryString=function(e,n,r){var o=new t([],"",null,!1,n,r);if(0===e.length||"?"===e)return o;var i=e.substring(1).split("&").map(function(t){return t.split("=")}).filter(function(t){return 2===t.length}).map(function(t){return{property:t[0],value:decodeURIComponent(t[1])}});return i.filter(function(t){return"body"===t.property}).forEach(function(t){var e;null!==(e=t.value.match(/^\/(.*)\/$/))?(o.body=e[1],o.regex=!0):(o.body=t.value,o.regex=!1)}),i.filter(function(t){return"username"===t.property}).forEach(function(t){return o.usernames=t.value.split(",")}),i.filter(function(t){return"id"===t.property}).forEach(function(t){return o.id=t.value}),o},t.fromKeywords=function(e,n,r){for(var o,i=new t([],"",null,!1,n,r),s=e.split(" "),a=0;a<s.length;a++)null===(o=s[a].match(/^from:([a-zA-Z0-9_]+(?:,[a-zA-Z0-9_]+)*)$/))?null===(o=s[a].match(/^id:(\d+)$/))?i.body+=s[a]:i.id=o[1]:i.usernames=o[1].split(",");return null!==(o=i.body.match(/^\/(.*)\/$/))&&(i.body=o[1],i.regex=!0),i},t}(),i=function(){function t(t,e,n){this.users=t,this.entryLength=e,this.dataTable=n}return t}(),s=function(){function t(t,e,n){var r=this;void 0===e&&(e=null),void 0===n&&(n=Enumerable.from(t)),this.elements=t,this.userIDs=e,this.enumerable=n,null===e&&(this.userIDs=this.enumerable.toDictionary(function(t){return t.target_id},function(t){return t.target_sn}),this.enumerable.forEach(function(t){return t.target_sn=r.userIDs.get(t.target_id)}))}return t.prototype.addRange=function(t){var e=this;t.forEach(function(t){return e.elements[e.elements.length]=t})},t.prototype.clone=function(){return new t(this.elements,this.userIDs,this.enumerable)},t.prototype.reset=function(){return new t(this.elements,this.userIDs)},t.prototype.getAllLength=function(){return this.elements.length},t.prototype.getEnumerable=function(){return this.enumerable},t.prototype.createStatistics=function(){var t=this.enumerable.groupBy(function(t){return t.target_id}).select(function(t){return{target_sn:t.firstOrDefault().target_sn,count:t.count()}}).orderByDescending(function(t){return t.count}).thenBy(function(t){return t.target_sn.toLowerCase()}).toArray();return new i(t,this.enumerable.count(),new google.visualization.DataTable({cols:[{type:"string",label:r.USERNAME},{type:"number",label:r.TWEETS_COUNT}],rows:t.map(function(t){return{c:[{v:t.target_sn},{v:t.count}]}})}))},t.prototype.sort=function(t){var e=this.clone();if(!t)return e;var n=t.order||2,r=t.orderBy||1,o=function(t,e){return t-e};return 1===n?1===r?e.enumerable=e.enumerable.orderBy(function(t){return t.record_date}):2===r&&(e.enumerable=e.enumerable.orderBy(function(t){return t.tweet_id},o)):2===n&&(1===r?e.enumerable=e.enumerable.orderByDescending(function(t){return t.record_date}):2===r&&(e.enumerable=e.enumerable.orderByDescending(function(t){return t.tweet_id},o))),e},t.prototype.filter=function(t){var e=this.clone();if(void 0===t||null===t)return e;var n;if(void 0!==t.body&&t.body.length>0)if(t.regex){try{n=new RegExp(t.body,"i")}catch(o){throw new Error(r.INCORRECT_REGEX)}e.enumerable=e.enumerable.where(function(t){return n.test(t.content)})}else t.body=t.body.toLowerCase(),e.enumerable=e.enumerable.where(function(e){return e.content.toLowerCase().contains(t.body)});return void 0!==t.usernames&&t.usernames.length>0&&(e.enumerable=e.enumerable.where(function(e){return t.usernames.some(function(t){return e.target_sn.toLowerCase()===t.toLowerCase()})})),null!==t.id&&(e.enumerable=e.enumerable.where(function(e){return e.tweet_id===t.id})),e},t}(),a=function(){function t(){}return t.init=function(){$.ajax({url:t.RECOTW_GET_ALL_URL,dataType:"json"}).done(function(e){t.entries=new s(e),l.onEntriesLoaded()}).fail(function(){l.onEntriesLoadFailed()})},t.getEntry=function(e){return null===t.entries?null:t.entries.getEnumerable().firstOrDefault(function(t){return t.tweet_id===e})},t.getEntries=function(){return null===t.entries?null:t.entries.getEnumerable()},t.getStatistics=function(){return null===t.entries?null:null!==t.statistics?t.statistics:t.statistics=t.entries.createStatistics()},t.setOptions=function(e){return null===t.entries?null:(t.entries=t.entries.reset().sort(e).filter(e),void(t.statistics=null))},t.validateURLorID=function(t){var e;if(void 0===t||null===t||0===t.length)return null;if(null!==(e=t.match(/^(?:(?:https?:\/\/(?:www\.|mobile\.)?)?twitter\.com\/(?:#!\/)?[a-zA-Z0-9_]+\/status(?:es)?\/(\d+)|(\d+))$/)))return e[1]||e[2];throw new Error(r.INCORRECT_URL_OR_ID)},t.postEntriesFromInputs=function(e,n,o){var i=e.map(function(e){return t.validateURLorID(e)});$.ajax({url:this.RECOTW_POST_URL,type:"POST",data:{id:i[0]},dataType:"json"}).done(function(t){n(t)}).fail(function(t){var e=t.responseJSON;o(e&&e.errors?r.POST_ERRORS[e.errors[0].code]||e.errors[0].message:r.POST_ERRORS.UNKNOWN_ERROR)})},t.createStatusURL=function(e){if("string"==typeof e)return String.format(t.TWITTER_STATUS_URL,e);if(void 0!==e.target_sn&&void 0!==e.tweet_id)return String.format(t.TWITTER_STATUS_URL.replace(/show/,e.target_sn),e.tweet_id);throw new Error(r.FAILED_TO_GENERATE_STATUS_URL)},t.createUserURL=function(e){if("string"==typeof e)return String.format(t.TWITTER_USER_URL,e);if(void 0!==e.target_sn)return String.format(t.TWITTER_USER_URL,e.target_sn);throw new Error(r.FAILED_TO_GENERATE_USER_URL)},t.createProfileImageURL=function(e){if(null===e)return t.ALTERNATIVE_ICON_URL;if("string"==typeof e)return String.format(t.TWITTER_PROFILE_IMAGE_URL,e);if(void 0!==e.target_sn)return String.format(t.TWITTER_PROFILE_IMAGE_URL,e.target_sn);throw new Error(r.FAILED_TO_GENERATE_PROFILE_IMAGE_URL)},t.setSearchQueryString=function(t){history&&history.pushState?history.pushState(null,null,location.pathname+t.toQueryString()):location.hash=t.toQueryString().slice(1)},t.startPolling=function(){null===t.pollingID&&(t.pollingID=window.setInterval(function(){$.ajax({url:t.RECOTW_COUNT_URL,type:"GET",dataType:"jsonp"}).done(function(e){e.count>t.entries.getAllLength()&&t.downloadLatestEntries().then(function(){return l.onNewEntries()})})},t.POLLING_INTERVAL))},t.stopPolling=function(){window.clearInterval(t.pollingID),t.pollingID=null},t.downloadLatestEntries=function(){return $.ajax({url:t.RECOTW_GET_ALL_URL,dataType:"jsonp"}).done(function(e){var n=$.Deferred();return n.resolve(t.entries.addRange(Enumerable.from(e).skip(t.entries.getAllLength()))),n})},t.ALTERNATIVE_ICON_URL="./images/none.png",t.TWITTER_STATUS_URL="https://twitter.com/show/status/{0}",t.TWITTER_USER_URL="https://twitter.com/{0}",t.TWITTER_PROFILE_IMAGE_URL="http://www.paper-glasses.com/api/twipi/{0}/",t.RECOTW_GET_ALL_URL="http://api.recotw.black/1/tweet/get_tweet_all",t.RECOTW_POST_URL="http://api.recotw.black/1/tweet/record_tweet",t.RECOTW_COUNT_URL="http://api.recotw.black/1/tweet/count_tweet",t.POLLING_INTERVAL=2e4,t.entries=null,t.statistics=null,t.pollingID=null,t}(),u=function(){function t(){}return t.getTabFromID=function(t){switch(t){case"home-tab":return 1;case"statistics-tab":return 2;default:return 0}},t.getCurrentTab=function(){return t.getTabFromID($(".tab-pane.active").attr("id"))},t.setCurrentTab=function(t){switch(t){case 1:return $("a[href='#home-tab']").tab("show");case 2:return $("a[href='#statistics-tab]").tab("show");default:return null}},t.setTitle=function(t){(""===location.hostname||"localhost"===location.hostname)&&(t="[DEBUG] "+t),document.title=t},t.createTwitterCB=function(t){twttr.widgets?t(twttr):twttr.ready(t)},t.renderHome=function(){var e=this;$("#no-result-container").hide(),l.setLoadingState(!1);var n=a.getEntries();return n.isEmpty()?void $("#no-result-container").fadeIn():(n.skip(t.current).take(t.TWEETS_COUNT).forEach(function(n){t.createTwitterCB(function(){twttr.widgets.createTweet(n.tweet_id,$("#main-area")[0],{lang:"ja"}).then(function(e,n,r){r?$(r).contents().find(".standalone-tweet").css({borderRadius:0}):t.showStatusLoadFailedMessage(e,n)}.bind(e,++t.widgetID,n))})}),void(t.current+=t.TWEETS_COUNT))},t.renderStatistics=function(e){if(null!==a.getEntries()){var n=a.getStatistics();if($("#no-result-container").hide(),null===t.chart&&(t.chart=new google.visualization.PieChart($("#statistics-chart")[0]),google.visualization.events.addListener(t.chart,"click",l.onChartSliceClick)),void 0===e){$("#statistics-count").text(String.format(r.STATISTICS_COUNT,n.entryLength));var o=l.getOptions();if($("#statistics-filter").text(o.isFiltered()?String.format(r.SEARCH_RESULT,o.toKeywords()):""),0===n.entryLength)return $("#statistics-chart").hide(),void $("#no-result-container").fadeIn();$("#statistics-chart").show(),t.chart.draw(n.dataTable,t.GRAPH_OPTIONS)}t.renderStatisticsTable(e,n)}},t.renderStatisticsTable=function(e,n){var o=n.users.filter(function(e){return e.count/n.entryLength>t.GRAPH_OPTIONS.sliceVisibilityThreshold}).length,i=$("#statistics-table").empty(),s="";e=void 0!==e?e.toLowerCase():void 0;for(var a=function(t){return void 0===e||t.toLowerCase().startsWith(e)},u=0;o>u;u++)a(n.users[u].target_sn)&&(s+=String.format(r.STATISTICS_TABLE_HTML,t.GRAPH_COLORS[u+1],n.users[u].target_sn,n.users[u].count,n.users[u].count/n.entryLength));for(var u=o;u<n.users.length;u++)a(n.users[u].target_sn)&&(s+=String.format(r.STATISTICS_TABLE_HTML,t.GRAPH_COLORS[0],n.users[u].target_sn,n.users[u].count,n.users[u].count/n.entryLength));i.append(0===s.length?r.NO_RESULT:s)},t.clearHome=function(){t.current=0,$("#main-area").empty()},t.setSearchKeywords=function(t){$("#search-box").val(t.toKeywords())},t.postEntries=function(){var e=$("#new-record-modal input[type='text']").map(function(){return $(this).val()}).get();try{a.postEntriesFromInputs(e.filter(function(t){return t.length>0}),t.showPostSuccessMessage,t.showPostFailedMessage),$("#new-record-modal").modal("hide")}catch(n){$("#inputPostStatus").val("").focus(),$("#new-record-modal .modal-dialog").shake(2,18,300)}},t.showPostSuccessMessage=function(){var t=$("#post-result");t.hide(),t[0].className="alert alert-success",$("#post-failed").hide(),$("#post-success").show(),t.fadeIn()},t.showPostFailedMessage=function(t){var e=$("#post-result");e.hide(),e[0].className="alert alert-danger",$("#post-success").hide(),$("#post-failed").show(),$("#post-failed-reason").text(t),e.fadeIn()},t.replaceLinkToURL=function(t){return t.replace(/[\r\n]/g,"<br>").replace(/https?:\/\/t\.co\/[A-Za-z0-9]+/g,function(t){return String.format(r.LINK_TO_URL_HTML,t)})},t.showStatusLoadFailedMessage=function(e,n){$("#twitter-widget-"+e).after(String.format(r.TWEET_REMOVED_HTML,a.createStatusURL(n),a.createProfileImageURL(n),a.createUserURL(n),n.target_sn,t.replaceLinkToURL(n.content))).remove()},t.TWEETS_COUNT=25,t.GRAPH_COLORS=[13421772,3368652,14432530,16750848,1087e3,10027161,39366,14500983,6728192,12070446,3236757,10044569,2271897,11184657,6697932,15102720,9111303,6623335,3314274,5600422,3882668,12022562,1496608,12129155,16004510,10246453,11125779,2783117,6720796,12493843,809250,7615505],t.GRAPH_OPTIONS={backgroundColor:"#FEFEFE",chartArea:{width:"90%",height:"100%"},is3D:!0,legend:"none",sliceVisibilityThreshold:.0099},t.chart=null,t.current=0,t.widgetID=-1,t}(),l=function(){function t(){}return t.getOptions=function(){return t.options},t.setOptions=function(e,n,o,i){try{a.setOptions(t.options=e)}catch(s){return void console.log(s.message)}if(o&&a.setSearchQueryString(e),i&&u.setSearchKeywords(e),e.isFiltered()?($("#clear-search-filter").show(),u.setTitle(String.format(r.PAGE_TITLE_SEARCH_RESULT,e.toKeywords()))):($("#clear-search-filter").hide(),u.setTitle(r.PAGE_TITLE_NORMAL)),$("#statistics-filter-textbox").val(""),null!==a.getEntries()){var l=u.getCurrentTab();2===l?(u.clearHome(),n?t.homeRendered=!1:t.reload()):t.reload()}},t.setLoadingState=function(e){t.loading=e},t.main=function(){u.setTitle(r.PAGE_TITLE_NORMAL),$("#app-version").text(n),navigator.standalone&&$(document.body).addClass("standalone"),a.init(),google.load("visualization","1.0",{packages:["corechart"]}),$("#loading-recotw").show(),t.setOptions(o.fromQueryString(location.search,2,1),!1,!1,!0),$(window).bottom({proximity:.05}),$(window).on("bottom",function(){1===u.getCurrentTab()&&t.onPageBottom()}),$(".navbar-nav a[role='tab']").on("shown.bs.tab",function(e){var n=function(t){return u.getTabFromID(t.href.substring(t.href.lastIndexOf("#")+1))};t.onTabSwitched(n(e.relatedTarget),n(e.target))}),$("#clear-search-filter").click(function(){t.setOptions(new o,!1,!0,!0)}),$(".order-radio-box").change(function(){t.options.order=t.getOrder(),t.options.orderBy=t.getOrderBy(),t.setOptions(t.options,!0,!1,!1)}),$("#search-form").submit(function(e){e.preventDefault(),t.setOptions(o.fromKeywords($("#search-box").val(),t.getOrder(),t.getOrderBy()),!1,!0,!1)}),$("#search-form-toggle-button").click(function(){var t=$(this),e=$("#search-form");t.hasClass("active")?(t.removeClass("active"),e.css({display:""})):(t.addClass("active"),e.css({cssText:"display: block !important"}))}),$(window).on("popstate",function(){t.setOptions(o.fromQueryString(location.search,t.getOrder(),t.getOrderBy()),!1,!1,!0)}),$("#reload-entries-link").click(function(){$("#polling-result").fadeOut(),t.showNewStatuses()}),$("#new-record-form").submit(function(t){t.preventDefault(),u.postEntries()}),$("#new-record-modal").on("shown.bs.modal",function(){$("#new-record-form .url-box").focus()}),$("#new-record-modal").on("hidden.bs.modal",function(){$("#new-record-form .modal-body").empty().html(r.URL_INPUT_AREA)}),$("#post-result-close").click(function(){$("#post-result").fadeOut()}),$("#polling-result-close").click(function(){$("#polling-result").fadeOut()}),$("#statistics-filter-textbox").on("keyup change",function(){t.setChartFilterByUsername($(this).val())}),$("#search-box").popover({placement:"bottom",html:!0,content:r.SEARCH_HELP_HTML}).blur(function(){$(this).popover("hide")}).keydown(function(t){(13===t.keyCode||27===t.keyCode)&&$(this).popover("hide")})},t.getOrder=function(){return $(".order-radio-box:checked").index(".order-radio-box")%2+1},t.getOrderBy=function(){return($(".order-radio-box:checked").index(".order-radio-box")/2^0)+1},t.reload=function(){if(null!==a.getEntries())switch(u.getCurrentTab()){case 1:u.clearHome(),u.renderHome(),$("#statistics-filter-textbox").val(""),t.homeRendered=!0,t.statisticsRendered=!1;break;case 2:u.renderStatistics(),t.homeRendered=!1,t.statisticsRendered=!0}},t.onEntriesLoaded=function(){$("#loading-recotw").fadeOut(),$("#loading-panel-container").fadeOut(),null!==a.getEntries()&&(a.startPolling(),t.setOptions(t.options,!1,!1,!0))},t.onEntriesLoadFailed=function(){$("#loading-panel").fadeOut().promise().done(function(){return $("#loading-error-panel").fadeIn()})},t.onNewEntries=function(){$("#polling-result").fadeIn()},t.isMobile=function(){return/iPhone|iPod|Android.*Mobile|Windows.*Phone/.test(navigator.userAgent)},t.onTabSwitched=function(e,n){switch(n){case 1:t.homeRendered||(u.renderHome(),t.homeRendered=!0);break;case 2:t.isMobile()||($("#statistics-filter-textbox").focus(),window.setTimeout(function(){return $("#statistics-table").animate({scrollTop:0},400)},100)),t.statisticsRendered||(u.renderStatistics(),t.statisticsRendered=!0)}},t.onPageBottom=function(){t.loading||(t.loading=!0,u.renderHome())},t.onImageError=function(t){t.src=a.createProfileImageURL(null)},t.onChartSliceClick=function(e){var n=e.targetID;n.contains("#")&&t.setSearchFilterByUsername(a.getStatistics().users[+n.substring(n.indexOf("#")+1)].target_sn)},t.onNewRecordFormTextBoxValueChanged=function(){var t=$(".url-input-area"),e=$(".url-box").map(function(){return $(this).val()}).get();t.each(function(t){$(this).removeClass("has-success has-error");try{null!==a.validateURLorID(e[t])&&$(this).addClass("has-success")}catch(n){$(this).addClass("has-error")}})},t.setSearchFilterByUsername=function(e){u.setCurrentTab(1),t.options.usernames=[e],t.setOptions(t.options,!1,!0,!0)},t.setChartFilterByUsername=function(t){u.renderStatistics(t)},t.showNewStatuses=function(){u.setCurrentTab(1),t.setOptions(new o([],"",null,!1,t.options.order,t.options.orderBy),!1,!0,!0),t.reload()},t.options=new o,t.loading=!1,t.homeRendered=!1,t.statisticsRendered=!1,t}();t.Controller=l,l.main()}(RecoTwExplorer||(RecoTwExplorer={}));